name: scrape-image

on:
  # 手動実行（Actions → このワークフロー → Run workflow）
  workflow_dispatch:

  # main ブランチに変更があったときも実行（テスト兼ねる）
  # push:
  #   branches: [main]
  #   paths:
  #     - "src/**"
  #     - "package.json"
  #     - "bun.lock*"
  #     - ".github/workflows/scrape-image.yml"

  # 8時間おきに自動実行（UTC 基準）
  schedule:
    - cron: "0 7,12,19,21,22,0 * * *"

jobs:
  run-scraper:
    runs-on: ubuntu-latest

    # 前の実行が終わってないのに次が走らないようにする
    concurrency:
      group: scrape-image
      cancel-in-progress: false

    env:
      TZ: Asia/Tokyo

      # ▼ GitHub Secrets に設定しておく（後で説明）
      TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
      TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
      NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
      NOTION_DATA_SOURCE_ID: ${{ secrets.NOTION_DATA_SOURCE_ID }}
      NOTION_VERSION: ${{ secrets.NOTION_VERSION }}
      X_APP_KEY: ${{ secrets.X_APP_KEY }}
      X_APP_SECRET: ${{ secrets.X_APP_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
      X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run scraper
        run: bun run src/main.ts

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: run-scraper
    if: failure()
    steps:
      - name: Send LINE Messaging API push message
        run: |
          MESSAGE="確認して"
          curl -X POST "https://api.line.me/v2/bot/message/push" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}" \
            -d "{
              \"to\": \"${LINE_USER_ID}\",
              \"messages\": [
                {
                  \"type\": \"text\",
                  \"text\": \"${MESSAGE}\"
                }
              ]
            }"
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
